# Nestling 项目进度日志 (Top-Level)

---

### 2025-09-07 15:30:00 (UTC+8)

*   **模块:** `root` (项目架构)
*   **修改内容:**
    1.  **架构重构:** 创建了 `frontend` 和 `backend` 文件夹，并将所有现存的前端代码移入 `frontend` 目录。
    2.  **技术决策:** 决定采用基于 Docker 和 Docker Compose 的容器化方案来搭建和管理开发环境。
*   **修改原因:**
    *   为了给即将开始的后端开发提供一个清晰、隔离的目录结构，并为整个项目引入现代化的、可复现的开发与部署工作流。
*   **实现效果:**
    *   项目结构现在能够清晰地分离前后端关注点，为全栈开发做好了准备。

---

### 2025-09-07 15:40:00 (UTC+8)

*   **模块:** `root`, `frontend`, `backend` (Docker & 后端)
*   **修改内容:**
    1.  **新增文件:** 在项目根目录创建了 `docker-compose.yml`，用于编排前后端服务。
    2.  **后端初始化:** 在 `backend` 目录下创建了 `Dockerfile`, `requirements.txt` 和 `main.py`，搭建了一个基础的 FastAPI 应用。
    3.  **前端容器化:** 在 `frontend` 目录下创建了 `Dockerfile`，用于构建 Vue 应用镜像。
    4.  **配置修改:** 更新了 `frontend/vite.config.js`，添加了 `server` 配置以确保其在 Docker 容器内正常运行。
*   **修改原因:**
    *   执行之前制定的容器化方案，为项目搭建一个隔离、可复现且生产就绪的开发环境。
*   **实现效果:**
    *   项目现在已完全容器化。开发者可以通过 `docker-compose up --build` 命令一键启动整个前后端应用，极大地简化了环境配置和项目管理。

---

### 2025-09-07 15:45:00 (UTC+8)

*   **模块:** `root`, `backend` (数据库集成)
*   **修改内容:**
    1.  **架构升级:** 更新了 `docker-compose.yml` 文件，新增了一个名为 `db` 的 PostgreSQL 服务。
    2.  **持久化:** 为数据库服务配置了名为 `postgres_data` 的 Docker 卷，以确保数据在容器重启后依然存在。
    3.  **服务连接:** 在 `docker-compose.yml` 中配置了 `backend` 服务，使其依赖 `db` 服务，并通过环境变量 (`DATABASE_URL`) 获取数据库连接信息。
    4.  **依赖更新:** 在 `backend/requirements.txt` 文件中添加了 `psycopg2-binary` 和 `SQLAlchemy`，为后端与 PostgreSQL 的交互提供必要的库。
*   **修改原因:**
    *   为应用程序提供一个持久化的数据存储层，这是所有数据驱动应用的核心需求。
*   **实现效果:**
    *   项目现在拥有了一个完整的、由 Docker Compose 管理的全栈架构（前端 + 后端 + 数据库）。后端服务已具备连接数据库所需的所有配置和依赖，为下一步开发数据模型和API接口奠定了坚实的基础。

---

### 2025-09-07 15:50:00 (UTC+8)

*   **模块:** `frontend` (Docker 构建)
*   **修改内容:**
    1.  **Bug修复:** 在排查 `docker-compose up --build` 命令失败的问题时，根据错误日志 `[vite:vue] crypto.hash is not a function` 和 Vite 的版本要求提示，将 `frontend/Dockerfile` 中的基础镜像从 `node:18-alpine` 升级到了 `node:20-alpine`。
*   **修改原因:**
    *   前端项目依赖（`@vitejs/plugin-vue`）需要一个比 `node:18` 更新的 Node.js 版本才能正常工作，导致生产构建失败。
*   **实现效果:**
    *   成功修复了前端 Docker 镜像的构建失败问题。整个应用（前端、后端、数据库）现在可以通过 `docker-compose up --build` 命令成功启动，开发环境已完全就绪。

---

### 2025-09-07 15:55:00 (UTC+8)

*   **模块:** `frontend` (Docker 配置)
*   **修改内容:**
    1.  **Bug修复:** 将 `frontend/Dockerfile` 从一个生产环境配置（使用 `npm run build` 和 Nginx）替换为了一个开发环境配置（使用 `npm run dev`）。
*   **修改原因:**
    *   之前的生产配置导致 `http://localhost:5173` 无法访问，因为它将服务暴露在容器的80端口，而非 `docker-compose.yml` 中映射的5173端口。此外，该配置不支持开发时至关重要的热重载功能。
*   **实现效果:**
    *   前端服务现在可以通过 `http://localhost:5173` 正确访问。更重要的是，开发体验得到了保障，代码修改可以实时在浏览器中反映出来，无需重新构建镜像。

---

### 2025-09-07 16:00:00 (UTC+8)

*   **模块:** `backend` (API & 数据库)
*   **修改内容:**
    1.  **架构重构:** 在 `backend` 目录下创建了 `app` 子目录，并将所有 Python 源代码按功能（`database.py`, `models.py`, `schemas.py`, `main.py`）进行模块化拆分。
    2.  **模型定义:** 在 `app/models.py` 中使用 SQLAlchemy 定义了 `User` 模型，映射到数据库的 `users` 表。
    3.  **自动迁移:** 在 `app/main.py` 中实现了应用启动时自动创建数据库表的功能。
    4.  **API开发:** 创建了第一个 API 端点 `POST /api/v1/users/`，用于创建新用户，并包含了密码哈希等安全措施。
    5.  **配置更新:** 更新了 `backend/Dockerfile` 以适应新的目录结构，并为 `uvicorn` 开启了 `--reload` 模式以支持热重载。
    6.  **依赖修复:** 将 `passlib` 添加到 `requirements.txt`，以支持密码加密功能。
*   **修改原因:**
    *   将后端从一个单一文件的原型，重构为一个结构清晰、可扩展的应用程序，并实现第一个核心功能（用户注册），为后续开发奠定基础。
*   **实现效果:**
    *   后端现在拥有一个清晰、模块化的代码结构。第一个核心API已完成并可通过 `http://localhost:8000/docs` 进行交互式测试。数据库 `users` 表会自动创建，开发工作流（热重载）也已建立。

---

### 2025-09-07 17:00:00 (UTC+8)

*   **模块:** `backend`, `frontend` (身份验证迁移)
*   **修改内容:**
    1.  **后端API:** 在 `backend/app/main.py` 中新增了 `POST /api/v1/token` 和 `GET /api/v1/users/me` 两个端点。
    2.  **后端认证逻辑:** 在 `backend/app/auth.py` 中实现了完整的 JWT 生成和验证逻辑，包括 `get_current_user` 依赖项，用于保护需要授权的端点。
    3.  **后端数据模型:** 扩展了 `backend/app/models.py` 和 `schemas.py` 中的 `User` 模型，使其包含 `unit`, `global_role`, 和 `roles_by_project` 字段，与前端的需求完全对齐。
    4.  **前端状态管理:** 重构了 `frontend/src/stores/authStore.js`。现在 `login` action 会调用后端 `/token` 端点获取JWT，然后通过 `/users/me` 端点获取完整的用户数据并存入状态。`tryAutoLogin` action 也被更新为使用存储的JWT来重新获取用户信息。
*   **修改原因:**
    *   将原先在前端模拟的、不安全的用户身份验证和权限管理逻辑，完全迁移到后端，实现真正的、基于JWT的安全认证流程。
*   **实现效果:**
    *   应用的登录、登出和自动登录功能现在完全由后端驱动，安全性得到了保障。前后端通过统一的API和数据模型进行交互，前端不再包含任何硬编码的用户数据或认证逻辑，为后续的功能开发和数据迁移打下了坚实的基础。

---

### 2025-09-07 19:30:00 (UTC+8)

*   **模块:** `backend`, `docker` (环境调试与数据库初始化)
*   **修改内容:**
    1.  **问题定位:** 解决了后端服务因数据库未完全就绪而启动失败的“竞态条件”问题。同时修复了因直接运行脚本导致的`ImportError`。
    2.  **服务健康检查:** 在 `docker-compose.yml` 中为数据库服务增加了 `healthcheck`，并让后端服务 `depends_on` 该健康检查，确保了服务的正确启动顺序。
    3.  **数据库初始化:** 创建了 `backend/app/seed.py` 脚本，用于在应用首次启动时自动向数据库中插入一个默认的管理员账户。
    4.  **启动命令更新:** 修改了 `docker-compose.yml` 中后端服务的 `command`，使其在启动API服务前先运行数据库初始化脚本。
*   **修改原因:**
    *   解决因服务启动顺序不当和数据库结构变更导致的后端崩溃问题。通过自动化的方式创建初始用户，简化开发环境的搭建和重置流程，避免手动操作的繁琐和易错性。
*   **实现效果:**
    *   开发环境的稳定性和可靠性得到提升。现在，通过 `docker-compose up` 启动应用后，一个可用的管理员账户会自动创建，开发者可以直接登录并开始测试，整个流程实现了完全自动化。

---

### 2025-09-07 20:00:00 (UTC+8)

*   **模块:** `backend` (数据库预置)
*   **修改内容:**
    1.  **扩展初始化脚本:** 更新了 `backend/app/seed.py` 脚本，使其包含并创建所有在 `frontend/src/auth.js` 中定义的预设用户账户。
*   **修改原因:**
    *   根据项目需求，这些账户需要被预先设置好并分发，而不是由用户自行注册。此举将所有预设用户数据统一到后端进行管理。
*   **实现效果:**
    *   每次通过 `docker-compose up` 启动一个全新的开发环境时，所有必需的用户账户都会被自动创建到数据库中，立即可用。这统一了开发和测试的用户基础，并完全移除了前端的模拟用户数据。
