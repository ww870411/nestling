# Nestling 项目进度日志

## 初始记录

*   **时间:** 2025-09-06 10:00:00 (UTC+8)
*   **操作:** 初始化项目进度日志 (`PROGRESS.md`)。

---

## 项目概述

### 1. 项目目的

`nestling` (雏鸟) 是一个可配置的前端应用程序框架，旨在快速构建数据驱动的业务应用。从项目结构和参考文件来看，其核心功能是为特定业务（如当前的 "2025-2026年度供热计划"）提供数据填报、展示、校验和管理的用户界面。它旨在标准化和简化类似数据收集与管理项目的开发流程。

### 2. 技术架构与实现

本项目是基于现代前端技术栈构建的单页面应用 (SPA)。

*   **核心框架:** [Vue.js](https://vuejs.org/) (v3)
*   **构建工具:** [Vite](https://vitejs.dev/)
*   **UI 组件库:** [Element Plus](https://element-plus.org/)
*   **路由管理:** [Vue Router](https://router.vuejs.org/)
*   **状态管理:** [Pinia](https://pinia.vuejs.org/)
*   **代码规范:** ESLint 和 Prettier 用于保证代码质量和风格统一。
*   **数据处理:** `xlsx` 库被用于处理 Excel 文件，这表明应用可能支持 Excel 数据的导入导出功能。

### 3. 目录结构简述

*   `src/`: 存放核心源代码。
*   `src/views/`: 存放应用的视图组件，如登录页 (`LoginView.vue`)、数据看板 (`DashboardView.vue`) 和数据录入页 (`DataEntryView.vue`)。
*   `src/router/`: 配置页面路由。
*   `src/stores/`: 通过 Pinia 管理全局应用状态。
*   `src/projects/`: 存放特定业务项目的配置文件、菜单、校验规则、数据模板等。这种设计使得 `nestling` 框架可以轻松适配不同的业务需求，具有良好的可扩展性。
*   `参考文件/`: 包含业务需求说明书、设计原型和模板数据，为开发提供了清晰的指引。

---

## 变更日志

### 2025-09-06 10:15:00 (UTC+8)

*   **模块:** `heating_plan_2025-2026` (项目配置)
*   **修改内容:**
    1.  在 `src/projects/heating_plan_2025-2026/` 目录下创建了 `templates` 文件夹。
    2.  将原有的 `template.js` 拆分为 `templates/groupTemplate.js` 和 `templates/subsidiaryTemplate.js`，以支持不同类型的报表模板。
    3.  更新 `menu.js`，为每个 `tables` 对象添加 `template` 属性，显式指定其所使用的模板。
    4.  删除了根目录下的旧 `template.js` 文件。
*   **修改原因:**
    *   原设计中所有报表共享同一个模板，无法满足集团公司报表 (ID '0') 与其他子公司报表具有不同结构的业务需求。
*   **实现效果:**
    *   实现了报表与模板的灵活对应关系，提高了项目配置的可扩展性和可维护性。现在可以为不同报表轻松指定不同的数据结构和列定义。

### 2025-09-06 10:20:00 (UTC+8)

*   **模块:** `projects`, `stores` (核心架构)
*   **修改内容:**
    1.  **Bug修复:** 修正了 `src/projects/index.js` 中的 `loadProjectConfig` 函数，移除了对已删除的 `template.js` 文件的动态导入。
    2.  **代码重构:** 更新了 `src/stores/projectStore.js` 中的 `loadProject` action，使其不再从项目配置的顶层加载 `reportTemplate` 和 `fieldConfig`。
*   **修改原因:**
    *   在将模板具体化到 `menu.js` 的每个条目后，旧的项目配置加载逻辑 (`loadProjectConfig`) 出错，因为它仍在尝试加载一个不存在的全局模板文件。
*   **实现效果:**
    *   修复了因模板重构导致的应用程序加载失败的 bug。
    *   使状态管理 (`projectStore`) 与新的项目配置结构保持一致。

### 2025-09-06 10:25:00 (UTC+8)

*   **模块:** `views` (UI/视图层)
*   **修改内容:**
    1.  **Bug修复:** 修改了 `src/views/DataEntryView.vue` 组件的逻辑。
    2.  **代码重构:** 组件不再从全局 `projectStore` 中直接获取 `reportTemplate` 和 `fieldConfig`。而是通过一个 `computed` 属性，根据当前路由参数 (`route.params.id`) 在 `menuData` 中查找对应的表格项，并动态获取其 `template` 配置。
    3.  **代码重构:** 更新了组件内的 `watch` 监听器，以响应动态获取的模板配置和路由变化。
*   **修改原因:**
    *   上一次重构将模板配置移入了 `menuData` 的具体表格项中，导致 `DataEntryView.vue` 无法从全局 store 中获取到配置，从而显示“暂无数据”。
*   **实现效果:**
    *   修复了点击具体报表链接后无法显示表格数据的 bug。
    *   `DataEntryView.vue` 现在可以正确地为不同的报表加载和渲染各自独立的模板和配置。

### 2025-09-06 10:30:00 (UTC+8)

*   **模块:** `heating_plan_2025-2026` (项目配置)
*   **修改内容:**
    1.  **代码重构:** 根据 `参考文件/0集团分单位汇总表.csv` 的列结构，完全重构了 `src/projects/heating_plan_2025-2026/templates/groupTemplate.js` 文件中的 `fieldConfig` 导出。
*   **修改原因:**
    *   集团公司的汇总报表需要展示所有下属单位的数据，其列结构与单个单位的数据填报表完全不同。旧的 `groupTemplate.js` 沿用了填报表的月度列结构，不符合业务需求。
*   **实现效果:**
    *   `groupTemplate.js` 现在准确地定义了集团汇总报表的列布局，为后续实现数据汇总功能打下了正确的基础。表格现在能够展示为每个单位分别设定的“本期计划”、“同期完成”和“差异率”列。

### 2025-09-06 10:35:00 (UTC+8)

*   **模块:** `views` (UI/视图层)
*   **修改内容:**
    1.  **功能增强:** 在 `DataEntryView.vue` 中添加了一个新的 `computed` 属性 `processedFieldConfig`。
    2.  **功能增强:** `processedFieldConfig` 会动态地将扁平的 `fieldConfig` 数组（其 `label` 属性使用 `-` 作为分隔符）转换为支持嵌套的结构。
    3.  **UI/UX:** 更新了 `el-table` 的渲染逻辑，利用 `v-if` 判断列配置是否包含子列，从而动态生成单级或多级（嵌套）的表头。
*   **修改原因:**
    *   对于具有多列的汇总报表（如集团汇总表），扁平的单级表头无法清晰地组织和展示数据。例如，多个单位的“本期计划”、“同期完成”列并排显示时，缺乏分组，可读性差。
*   **实现效果:**
    *   表格现在支持多级表头显示。例如，“集团全口径-本期计划”和“集团全口-同期完成”等列，现在会正确地显示在一个合并的“集团全口径”表头之下，显著提高了复杂表格的可读性和用户体验。此更改完全在视图层实现，未影响任何数据结构。

### 2025-09-06 10:45:00 (UTC+8)

*   **模块:** `heating_plan_2025-2026` (项目配置), `views` (UI/视图层)
*   **修改内容:**
    1.  **架构升级:** 将单元格可写性的规则，以内联 `requiredProperties` 对象的形式，直接添加到了 `subsidiaryTemplate.js` 和 `groupTemplate.js` 的每个指标定义中。这些规则数据来源于 `0集团分单位汇总表.csv`。
    2.  **架构升级:** 重构了 `tableRules.js` 中的 `isCellWritable` 函数。它现在会读取指标行内联的 `requiredProperties`，并与当前表格的 `properties` 进行比较，以决定单元格是否可写。
    3.  **代码重构:** 更新了 `DataEntryView.vue`，确保在初始化表格行数据时，将 `requiredProperties` 从模板传递到每一行，供 `isCellWritable` 函数使用。
*   **修改原因:**
    *   之前将可写性规则定义在 `tableRules.js` 中的方案不够直观，规则的定义与指标本身分离。将规则直接附加到指标模板上，使得数据结构更加内聚和清晰。
*   **实现效果:**
    *   实现了最终的、高度灵活且逻辑清晰的单元格可写性控制系统。现在，一个指标是否可写，由其自身的元数据 (`requiredProperties`) 和其所在表格的业务属性 (`properties`) 共同决定，完全实现了配置驱动。开发者未来只需维护模板文件和 `menu.js`，即可精确控制整个系统的行为。

### 2025-09-06 10:50:00 (UTC+8)

*   **模块:** `views` (UI/视图层), `projects` (项目配置)
*   **修改内容:**
    1.  **Bug修复:** 修复了 `subsidiaryTemplate.js` 和 `groupTemplate.js` 中由于手误导致的 `requiredProperties` 对象语法错误。
    2.  **架构升级:** 将 `tableRules.js` 中的 `isCellWritable` 布尔函数升级为 `getCellState` 函数，使其能返回 `'WRITABLE'`, `'READONLY_CALCULATED'`, `'READONLY_DISPLAY'` 等多种状态。
    3.  **代码重构:** 在 `DataEntryView.vue` 中，使用 `getCellState` 的返回结果来动态决定单元格的渲染方式（输入框或文本）和样式（是否加粗）。
    4.  **代码重构:** 重写了 `calculateAll` 函数，使其逻辑更清晰，能正确处理行内计算和列内计算，并修复了之前版本中部分计算未执行的bug。
*   **修改原因:**
    *   部分计算指标没有正确加粗显示，且其计算未被执行。根本原因是 `calculateAll` 函数未能正确识别所有应计算的单元格，且样式逻辑与计算逻辑脱钩。
*   **实现效果:**
    *   统一了单元格状态的判断逻辑，确保了所有只读的计算单元格（无论是模板中预定义的还是根据业务规则动态决定的）都能被正确识别。
    *   修复了计算不执行和样式不正确的 bug，确保了数据的准确性和显示的一致性。

### 2025-09-06 10:55:00 (UTC+8)

*   **模块:** `projects` (项目配置)
*   **修改内容:**
    1.  **Bug修复:** 在 `tableRules.js` 的 `getCellState` 函数中，增加了一条高优先级的规则，确保所有在模板中定义为 `type: 'calculated'` 的指标行，都始终返回 `READONLY_CALCULATED` 状态。
*   **修改原因:**
    *   之前的 `getCellState` 函数遗漏了对 `row.type === 'calculated'` 的直接判断，可能导致某些预定义的计算指标在特定情况下被错误地判断为可写。
*   **实现效果:**
    *   强化了规则的严谨性，确保了预定义计算指标的只读和计算状态不会被后续的业务规则意外覆盖，提高了系统的稳定性。

### 2025-09-06 11:00:00 (UTC+8)

*   **模块:** `views` (UI/视图层)
*   **修改内容:**
    1.  **Bug修复:** 修正了 `DataEntryView.vue` 中的 `getCellStyle` 函数。新的逻辑会判断当前列是否为数值列，确保只有数值列才会被应用粗体样式。
*   **修改原因:**
    *   旧的样式逻辑过于宽泛，它会为计算指标行的所有单元格（包括指标名称和单位列）都应用粗体，导致显示错误。
*   **实现效果:**
    *   修复了计算指标行的指标名称和单位被错误加粗的问题，确保了表格的显示样式符合预期。

### 2025-09-06 11:10:00 (UTC+8)

*   **模块:** `auth`, `stores`, `views`, `router` (全系统)
*   **修改内容:**
    1.  **架构设计:** 引入了统一身份认证和基于项目的授权模型，以支持未来多项目、多角色的扩展需求。
    2.  **新增文件:** 创建了 `src/auth.js` 用于模拟用户数据库，并创建了 `src/stores/authStore.js` (Pinia) 来管理全局用户状态。
    3.  **代码重构:** 全面重构了 `LoginView.vue`，使其接入新的 `authStore` 进行登录验证。
    4.  **权限控制:** 在 `MainLayout.vue` 中实现了菜单的动态过滤，确保用户只能看到其角色权限允许访问的单位列表。
    5.  **代码重构:** 更新了 `router/index.js` 中的全局导航守卫，使其与 `authStore` 集成，实现了持久化登录和路由保护。
*   **修改原因:**
    *   原系统没有账号体系，只有一个硬编码的管理员。为了实现多用户、多层级的权限管理，需要一套可扩展的认证和授权机制。
*   **实现效果:**
    *   成功为应用构建了一套灵活、可扩展的前端模拟权限系统。现在系统可以区分集团管理员、区域管理员和普通单位填报员，并为他们展示不同的视图，为下一步开发更复杂的业务流程（如审核流）打下了坚实的基础。

### 2025-09-06 11:20:00 (UTC+8)

*   **模块:** `layouts` (UI/视图层)
*   **修改内容:**
    1.  **UI/UX:** 修改了 `MainLayout.vue` 的顶部栏，在“欢迎使用”的文本前，增加了当前登录用户的用户名。
*   **修改原因:**
    *   为了提升用户体验，让用户能清晰地看到当前登录的账号。
*   **实现效果:**
    *   登录后顶栏会显示 “username, 欢迎使用”，交互更加友好。

### 2025-09-06 11:25:00 (UTC+8)

*   **模块:** `router` (路由)
*   **修改内容:**
    1.  **Bug修复:** 重构了 `src/router/index.js` 中的 `beforeEach` 导航守卫，增加了对 `data-entry/:id` 路由的细粒度权限校验。
*   **修改原因:**
    *   之前的导航守卫只检查了用户是否登录和项目是否加载，但没有检查用户是否有权访问通过 URL 直接输入的具体报表 ID，导致存在权限漏洞。
*   **实现效果:**
    *   现在，当用户尝试直接访问某个报表页面时，系统会根据其登录角色和 `authStore` 中定义的 `accessibleUnits` 列表，判断其是否有权访问该报表所属的单位。如果无权访问，则会重定向到 `/dashboard` 页面，有效堵塞了权限漏洞。

---

### 2025-09-06 12:00:00 (UTC+8)

*   **模块:** `router`, `views`, `layouts` (核心路由系统)
*   **修改内容:**
    1.  **架构升级:** 重构了 `src/router/index.js`，将项目ID (`projectId`) 整合进URL结构中。现在的URL格式为 `/project/:projectId/dashboard` 或 `/project/:projectId/data-entry/:tableId`。
    2.  **架构升级:** 极大地增强了 `router.beforeEach` 导航守卫。它现在会直接从URL参数中解析 `projectId` 来加载项目配置，彻底移除了之前对 `localStorage` 的依赖，使路由行为更加健壮和无状态。
    3.  **代码重构:** 更新了 `src/views/ProjectSelectionView.vue`，使其在选择项目后跳转到新的、包含 `projectId` 的URL。
    4.  **代码重构:** 更新了 `src/layouts/MainLayout.vue`，使其能从当前URL中动态获取 `projectId`，并为侧边栏菜单生成正确的、包含项目上下文的链接。
*   **修改原因:**
    *   旧的URL结构 (`/data-entry/:id`) 没有包含项目上下文，导致在多项目场景下URL存在歧义，并且在刷新页面时严重依赖 `localStorage` 中的隐式状态，系统鲁棒性差。
*   **实现效果:**
    *   **URL清晰化:** URL现在能准确反映应用的完整状态（项目+报表），方便分享和调试。
    *   **健壮性提升:** 即使清空浏览器缓存，只要URL正确，应用就能恢复到正确的状态。
    *   **为多项目扩展铺平道路:** 新的路由结构从根本上解决了多项目导航的问题，为未来扩展新项目奠定了坚实的基础。

---

### 2025-09-06 12:05:00 (UTC+8)

*   **模块:** `views` (UI/视图层)
*   **修改内容:**
    1.  **Bug修复:** 修复了因路由重构导致的导航失效问题。具体包括：
        *   在 `DataEntryView.vue` 中，将获取路由参数的方式从 `route.params.id` 修正为 `route.params.tableId`。
        *   在 `DashboardView.vue` 中，更新了“进入”按钮的跳转逻辑，使其生成符合新路由结构的URL (`/project/:projectId/data-entry/:tableId`)。
    2.  **Bug修复:** 修复了在 `DashboardView.vue` 中因修改代码引入的 `Identifier 'projectStore' has already been declared` 的编译错误。
*   **修改原因:**
    *   在上一轮路由重构中，未能同步更新所有使用到路由参数和导航跳转的地方，导致了功能性BUG和编译错误。
*   **实现效果:**
    *   恢复了应用的正常导航功能。现在从仪表盘和侧边栏都能正确跳转到数据填报页面。

---

### 2025-09-06 12:10:00 (UTC+8)

*   **模块:** `views` (UI/视图层)
*   **修改内容:**
    1.  **UI/UX:** 在 `DataEntryView.vue` 组件中，移除了页脚工具栏表格缩放选项中的 “50%” 按钮。
*   **修改原因:**
    *   用户反馈在50%缩放比例下，表格布局混乱，可用性差，因此决定移除该选项。
*   **实现效果:**
    *   简化了UI，避免用户选择一个体验不佳的选项，提升了整体的用户体验。
---

### 2025-09-07 14:30:00 (UTC+8)

*   **模块:** `utils`, `views` (校验系统)
*   **修改内容:**
    1.  **功能增强:** 增强了 `src/utils/validator.js` 中的 `comparison` 校验函数，为其增加了一个可选的 `factor` (系数)参数。
    2.  **代码重构:** 更新了 `src/views/DataEntryView.vue` 中的 `runValidation` 方法，使其在调用 `comparison` 规则时能够传递 `factor` 参数。
*   **修改原因:**
    *   原有的 `comparison` 校验规则只能对两个字段进行直接的值比较（如 A > B），无法满足更复杂的业务需求，例如“A的值不应小于B的95%”。
*   **实现效果:**
    *   校验引擎现在支持基于百分比的相对比较。开发者可以在 `tableRules.js` 中通过配置 `{ rule: 'comparison', ..., factor: 0.95 }` 来声明复杂的业务规则，提高了校验系统的灵活性和可扩展性，无需再为类似需求硬编码新规则。
---

### 2025-09-07 14:35:00 (UTC+8)

*   **模块:** `utils`, `views` (校验系统)
*   **修改内容:**
    1.  **功能增强:** 再次增强了 `src/utils/validator.js` 中的 `comparison` 校验函数，增加了一个可选的 `offset` (偏移量)参数。
    2.  **代码重构:** 相应地更新了 `src/views/DataEntryView.vue` 中的 `runValidation` 方法，使其能够传递 `offset` 参数。
*   **修改原因:**
    *   在支持了乘法系数(`factor`)后，发现业务中还存在加减修正值的比较需求（例如 A > B + 100），原有系统无法满足。
*   **实现效果:**
    *   校验引擎现在同时支持系数和偏移量，可以组合使用（乘法优先）。这使得 `comparison` 规则变得极为强大和灵活，能够以纯配置的方式覆盖几乎所有的数值比较类业务场景，进一步提升了框架的可扩展性。
---

### 2025-09-07 15:00:00 (UTC+8)

*   **模块:** `projects`, `views` (校验系统架构)
*   **修改内容:**
    1.  **架构升级:** 在 `tableRules.js` 中建立了可复用的、命名的校验方案库 `validationSchemes`。
    2.  **架构升级:** 重构了 `DataEntryView.vue` 的校验引擎，使其支持“混合模式”校验。现在可以为报表指定一个基础的 `validationScheme`，并能通过 `validationOverrides` 对单个指标进行规则的精确覆盖或禁用。
    3.  **配置更新:** 在 `menu.js` 中，为报表1-14应用了 `validationOverrides`，实现了排除特定指标（1-5）和修改特定指标（115）校验规则的业务需求。
*   **修改原因:**
    *   原有的校验系统是全局性的，无法为不同的报表或单位配置差异化的校验规则，缺乏灵活性。
*   **实现效果:**
    *   成功实现了一个高度灵活、可配置的校验系统。现在可以通过 `menu.js` 的配置，轻松实现校验规则的复用、覆盖和禁用，完美支持了复杂的、因表而异的业务校验需求，极大地提升了框架的适应性和可维护性。
